
worker_processes 1;

events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;

  # If you prefer decompressing instead of disabling upstream gzip:
  # load_module "modules/ngx_http_gunzip_module.so";  # already present in many builds
  # gunzip on;    # uncomment if you don't use Accept-Encoding "" below

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  upstream nextjs {
    server 127.0.0.1:3000;
    keepalive 64;
  }

  server {
    listen 8080;

    # Capture the ingress prefix and the rest of the path
    location ~ ^(?<ing>/api/hassio_ingress/[^/]+)/(.*)$ {
      # Strip the prefix before sending to Next.js
      set $upstream_uri /$2;

      # Deterministic prefix (even if header is missing)
      set $prefix $ing;

      # Optionally still pass the header (some apps read it)
      proxy_set_header X-Forwarded-Prefix $prefix;

      # Ensure upstream sends *plain* (not gzip/br/zstd) so sub_filter can rewrite
      proxy_set_header Accept-Encoding "";

      add_header X-Debug-Prefix $prefix always;

      # Let sub_filter run on many body types while we verify
      sub_filter_once off;
      sub_filter_types text/html text/css text/javascript application/javascript application/json;

      # Rewrite generic occurrences first (catch all)
      sub_filter '/_next/'              '$prefix/_next/';

      # Target common attributes used by Next.js
      sub_filter 'href="/_next/'        'href="$prefix/_next/';
      sub_filter 'src="/_next/'         'src="$prefix/_next/';
      sub_filter 'content="/_next/'     'content="$prefix/_next/';

      # Data and image optimizer endpoints
      sub_filter 'href="/_next/data/'   'href="$prefix/_next/data/';
      sub_filter 'src="/_next/data/'    'src="$prefix/_next/data/';
      sub_filter 'src="/_next/image'    'src="$prefix/_next/image';

      # Static media/fonts and other root assets
      sub_filter 'src="/_next/static/'  'src="$prefix/_next/static/';
      sub_filter 'href="/_next/static/' 'href="$prefix/_next/static/';
      sub_filter 'href="/favicon'       'href="$prefix/favicon';
      sub_filter 'href="/manifest'      'href="$prefix/manifest';

      # Optional catch-alls (put after specifics to avoid double-prefixing)
      sub_filter 'href="/'              'href="$prefix/';
      sub_filter 'src="/'               'src="$prefix/';

      # Proxy headers and upstream
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_pass http://nextjs$upstream_uri;
    }


    # Fallback (direct/health)
    location / {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_pass http://nextjs;
    }
  }
}
